<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ProElec V35 - Smart Check</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg: #e0e5ec; --primary: #3b82f6; --text-main: #1f2937; --danger: #ef4444; --success: #10b981; --warning: #f59e0b; --whatsapp: #25D366;
            --shadow-light: #ffffff; --shadow-dark: #a3b1c6;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); color: var(--text-main); padding-bottom: 120px; min-height: 100vh; }
        .app-container { width: 100%; max-width: 500px; margin: 0 auto; padding: 25px 15px; display: block; }

        /* --- UI Components --- */
        .neu-box { background: var(--bg); border-radius: 25px; box-shadow: 9px 9px 18px var(--shadow-dark), -9px -9px 18px var(--shadow-light); padding: 25px; margin-bottom: 30px; border: 1px solid rgba(255,255,255,0.4); transition: all 0.3s ease; }
        .neu-input, .neu-select { width: 100%; border: none; background: var(--bg); border-radius: 15px; padding: 16px; margin-bottom: 12px; font-weight: 600; box-shadow: inset 6px 6px 12px var(--shadow-dark), inset -6px -6px 12px var(--shadow-light); outline: none; }
        .neu-btn { background: var(--bg); border: none; border-radius: 18px; box-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light); color: var(--primary); font-weight: 700; padding: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.2s; }
        .neu-btn:active { transform: scale(0.95); box-shadow: inset 6px 6px 12px var(--shadow-dark), inset -6px -6px 12px var(--shadow-light); }
        .btn-green { color: var(--success); } .btn-red { color: var(--danger); }
        .btn-icon-only { width: 45px; height: 45px; border-radius: 50%; padding: 0; }

        .action-btn { width: 35px; height: 35px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; background: var(--bg); box-shadow: 4px 4px 8px var(--shadow-dark), -4px -4px 8px var(--shadow-light); transition: all 0.2s ease; }
        .action-btn:active { transform: scale(0.9); }
        .btn-edit-icon { color: var(--warning); font-size: 0.9rem; }
        .btn-del-icon { color: var(--danger); font-size: 0.9rem; }

        /* Cloud Status */
        .cloud-status { text-align: center; font-size: 0.8rem; margin-bottom: 10px; font-weight: bold; }
        .status-online { color: var(--success); }
        .status-offline { color: var(--danger); }
        .status-loading { color: var(--warning); }

        /* Header */
        .brand-container { text-align: center; margin-bottom: 25px; position: relative; }
        .brand-title { font-size: 2.2rem; font-weight: 800; background: linear-gradient(45deg, var(--primary), #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: inline-block; }
        .brand-slogan { font-size: 0.9rem; color: #6b7280; margin-top: 5px; }
        .admin-btn { position: absolute; top: 0; left: 0; color: #6b7280; background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 10px; }

        /* Grid & List */
        .services-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .services-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 18px; }
        .services-grid .neu-btn { flex-direction: column; height: 110px; color: #6b7280; position: relative; overflow: hidden; }
        .services-grid .neu-btn i { font-size: 1.8rem; color: var(--primary); margin-bottom: 8px; }
        .price-tag { font-size: 0.75rem; color: var(--primary); margin-top: 5px; opacity: 0.8; }
        
        .manual-add-section { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 20px; }
        .manual-row { display: flex; gap: 10px; }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(255,255,255,0.4); border-radius: 15px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.5); }
        
        /* Floating Dock */
        .fab-bar { position: fixed; bottom: 25px; left: 20px; right: 20px; display: flex; gap: 15px; z-index: 1000; background: rgba(224, 229, 236, 0.95); backdrop-filter: blur(10px); padding: 12px 15px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,0.3); }
        .fab-main { flex: 2; background: linear-gradient(135deg, var(--primary), #2563eb); color: white !important; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4); }
        .fab-action { flex: 1; background: #1f2937; color: white !important; }
        .fab-whatsapp { flex: 1; color: var(--whatsapp) !important; font-size: 1.5rem; }

        /* Modern Modals Styling */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(8px); animation: fadeIn 0.2s ease-out; }
        .modal-content { background: #e0e5ec; padding: 25px; border-radius: 25px; width: 90%; max-width: 380px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); max-height: 85vh; overflow-y: auto; position: relative; border: 1px solid rgba(255,255,255,0.5); animation: scaleUp 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .modal-header { text-align: center; margin-bottom: 20px; }
        .modal-icon { width: 60px; height: 60px; border-radius: 50%; background: var(--bg); box-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light); display: flex; align-items: center; justify-content: center; margin: 0 auto 15px auto; color: var(--primary); font-size: 1.5rem; }
        .modal-title { font-size: 1.2rem; font-weight: 800; color: var(--text-main); }
        .modal-desc { font-size: 0.9rem; color: #666; margin-top: 5px; }
        
        .setting-group { margin-bottom: 15px; }
        .setting-group label { display: block; margin-bottom: 5px; color: var(--primary); font-weight: bold; font-size: 0.9rem; }
        .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .setting-row input { width: 100px; padding: 10px; text-align: center; }

        /* --- Print System --- */
        #printable-area { display: none; }
        @media print {
            .app-container, .fab-bar, .modal-overlay, #importFile { display: none !important; }
            html, body { background: white; margin: 0 !important; padding: 0 !important; height: auto !important; overflow: hidden !important; }
            #printable-area { display: block !important; position: absolute; top: 0; left: 0; width: 100%; padding: 10px; background: white; color: black; }
            .invoice-header { text-align: center; margin-bottom: 10px; border-bottom: 2px solid var(--primary); padding-bottom: 5px; }
            .company-name { font-size: 1.8rem; font-weight: 800; color: var(--primary) !important; margin-bottom: 2px; }
            .company-details { font-size: 0.8rem; color: #333; margin-bottom: 2px; line-height: 1.2; }
            .invoice-meta { display: flex; justify-content: space-between; background: #f8f9fa !important; padding: 6px 10px; border-radius: 6px; border: 1px solid #eee; font-size: 0.8rem; margin-bottom: 10px; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 0.85rem; }
            th { background-color: #f3f4f6 !important; color: #111 !important; padding: 4px; border: 1px solid #ccc; font-weight: bold; }
            td { border: 1px solid #ccc; padding: 4px; color: #111; text-align: center; }
            .totals-box { width: 45%; margin-right: auto; background: #f9fafb !important; border: 1px solid #eee; padding: 8px; border-radius: 6px; page-break-inside: avoid; font-size: 0.85rem; margin-top: 5px; }
            @page { margin: 0.5cm; size: A4 portrait; }
        }
    </style>
</head>
<body>

    <div class="app-container">
        
        <div class="brand-container">
            <button class="admin-btn" onclick="openAdminPanel()"><i class="fas fa-lock"></i></button>
            <div class="brand-title" id="displayAppName">ProElec</div>
            <div class="brand-slogan" id="displayAppDesc">Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙˆØªØ±Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</div>
            <div id="cloudStatus" class="cloud-status status-loading"><i class="fas fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø©...</div>
        </div>

        <div class="neu-box">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="color:var(--text-main)"><i class="fas fa-user-circle"></i> Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
                <div style="display:flex; gap:10px;">
                    <button class="neu-btn btn-icon-only" onclick="openClientModal(false)" title="Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯"><i class="fas fa-plus"></i></button>
                    <button class="neu-btn btn-icon-only" onclick="openClientModal(true)" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…" style="color:var(--warning)"><i class="fas fa-pen"></i></button>
                    <button class="neu-btn btn-icon-only" onclick="openDeleteModal()" title="Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„" style="color:var(--danger)"><i class="fas fa-trash"></i></button>
                </div>
            </div>
            
            <select id="clientDropdown" class="neu-select" onchange="loadClient(this.value)"><option value="">-- Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„Ø§Ù‹ --</option></select>
            
            <select id="docType" class="neu-input" style="margin-top:10px;"><option>ÙØ§ØªÙˆØ±Ø© Ù†Ù‡Ø§Ø¦ÙŠØ©</option><option>Ø¹Ø±Ø¶ Ø³Ø¹Ø± (Devis)</option></select>
        </div>

        <div class="neu-box">
            <div class="services-header">
                <h3 style="color:var(--text-main)"><i class="fas fa-bolt" style="color:var(--warning)"></i> Ø¥Ø¶Ø§ÙØ© Ø³Ø±ÙŠØ¹Ø©</h3>
                <button class="neu-btn btn-icon-only" onclick="openPriceSettings()" style="width:35px; height:35px; color:#666;"><i class="fas fa-tags"></i></button>
            </div>
            <div class="services-grid" id="quickButtonsGrid"></div>
            <div class="manual-add-section">
                <label style="font-size:0.9rem; color:#666; margin-bottom:-5px;">Ø®Ø¯Ù…Ø§Øª Ø£Ø®Ø±Ù‰:</label>
                <select id="extraServicesDropdown" class="neu-select" onchange="fillManualInput(this)">
                    <option value="">-- Ø§Ø®ØªØ± Ø®Ø¯Ù…Ø© Ù„Ù„Ø¥Ø¶Ø§ÙØ© --</option>
                    <option value="1200|ØªØ±ÙƒÙŠØ¨ Ø«Ø±ÙŠØ§ (Lustre)">ØªØ±ÙƒÙŠØ¨ Ø«Ø±ÙŠØ§ (1200 Ø¯.Ø¬)</option>
                    <option value="400|ØªØ±ÙƒÙŠØ¨ Ø³Ø¨ÙˆØª (Spot)">ØªØ±ÙƒÙŠØ¨ Ø³Ø¨ÙˆØª (400 Ø¯.Ø¬)</option>
                    <option value="1500|Ù…Ø£Ø®Ø° Ù…ÙƒÙŠÙ (Climatiseur)">Ù…Ø£Ø®Ø° Ù…ÙƒÙŠÙ (1500 Ø¯.Ø¬)</option>
                    <option value="2500|ØªØ£Ø±ÙŠØ¶ (Mise Ã  la terre)">ØªØ£Ø±ÙŠØ¶ (2500 Ø¯.Ø¬)</option>
                    <option value="800|Ø¬Ø±Ø³ Ø¨Ø§Ø¨ (Sonnette)">Ø¬Ø±Ø³ Ø¨Ø§Ø¨ (800 Ø¯.Ø¬)</option>
                    <option value="3000|Ø§Ù†ØªØ±ÙÙˆÙ† (Interphone)">Ø§Ù†ØªØ±ÙÙˆÙ† (3000 Ø¯.Ø¬)</option>
                    <option value="2500|ÙƒØ§Ø´Ù Ø­Ø±ÙƒØ© (DÃ©tecteur)">ÙƒØ§Ø´Ù Ø­Ø±ÙƒØ© (2500 Ø¯.Ø¬)</option>
                    <option value="1500|Ù…Ø±ÙˆØ­Ø© Ø³Ù‚Ù">Ù…Ø±ÙˆØ­Ø© Ø³Ù‚Ù (1500 Ø¯.Ø¬)</option>
                </select>
                <div class="manual-row">
                    <input type="text" id="manualName" class="neu-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø©" style="flex:2; margin:0">
                    <input type="number" id="manualPrice" class="neu-input" placeholder="Ø§Ù„Ø³Ø¹Ø±" style="flex:1; margin:0">
                    <button class="neu-btn btn-green" onclick="addManualItem()" style="width:50px;"><i class="fas fa-plus"></i></button>
                </div>
            </div>
        </div>

        <div class="neu-box">
            <h3 style="margin-bottom:15px; color:var(--text-main)"><i class="fas fa-file-invoice-dollar"></i> Ø§Ù„ÙØ§ØªÙˆØ±Ø©</h3>
            <ul id="list" style="list-style:none; min-height:50px; padding:0;"></ul>
            <div style="margin-top:25px; padding:15px; border:2px dashed rgba(163, 177, 198, 0.5); border-radius:15px;">
                <h4 style="margin-bottom:10px; color:#6b7280; font-size:0.9rem;">ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø©</h4>
                <div style="display:flex; gap:10px;">
                    <input type="number" id="payAmount" class="neu-input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" style="flex:1; margin:0">
                    <input type="date" id="payDate" class="neu-input" style="flex:1; margin:0">
                </div>
                <button class="neu-btn btn-green" onclick="addPayment()" style="width:100%; margin-top:10px; border-radius:12px;"><i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙØ¹Ø©</button>
                <div id="payList" style="margin-top:15px;"></div>
            </div>
            <div style="margin-top:20px; padding-top:15px; border-top:1px solid rgba(0,0,0,0.05);">
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;"><span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</span><span id="totalTxt" style="font-weight:700; color:var(--primary)">0</span></div>
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;"><span>Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</span><span id="paidTxt" style="font-weight:700; color:var(--success)">0</span></div>
                <div style="display:flex; justify-content:space-between; font-size:1.3rem; font-weight:800; color:var(--danger); margin-top:15px;"><span>Ø§Ù„Ø¨Ø§Ù‚ÙŠ:</span><span id="remainTxt">0</span></div>
            </div>
        </div>

        <div class="fab-bar">
            <button class="neu-btn fab-main" onclick="manualSave()"><i class="fas fa-cloud-upload-alt"></i> Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</button>
            <button class="neu-btn fab-whatsapp" onclick="shareWhatsapp()"><i class="fab fa-whatsapp"></i></button>
            <button class="neu-btn fab-action" onclick="forcePrint()"><i class="fas fa-print"></i></button>
        </div>
    </div>

    <div id="clientModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon"><i class="fas fa-user-edit"></i></div>
                <h3 class="modal-title" id="clientModalTitle">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
                <p class="modal-desc">Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø£Ùˆ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯</p>
            </div>
            <div class="setting-group">
                <input type="text" id="modalClientName" class="neu-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„..." style="text-align:center;">
                <input type="hidden" id="isEditMode">
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="neu-btn btn-green" onclick="confirmSaveClient()" style="flex:2">Ø­ÙØ¸</button>
                <button class="neu-btn btn-red" onclick="closeModal('clientModal')" style="flex:1">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <div id="deleteModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon" style="color:var(--danger)"><i class="fas fa-exclamation-triangle"></i></div>
                <h3 class="modal-title" style="color:var(--danger)">Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ</h3>
                <p class="modal-desc">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.</p>
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="neu-btn btn-red" onclick="confirmDeleteClient()" style="flex:2">Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù</button>
                <button class="neu-btn" onclick="closeModal('deleteModal')" style="flex:1">ØªØ±Ø§Ø¬Ø¹</button>
            </div>
        </div>
    </div>

    <div id="pinModal" class="modal-overlay"><div class="modal-content" style="text-align:center;"><h3>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</h3><p>Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ</p><input type="password" id="adminPinInput" class="neu-input" placeholder="****" style="text-align:center;font-size:1.5rem;letter-spacing:5px;"><div style="display:flex;gap:10px;margin-top:15px;"><button class="neu-btn btn-green" onclick="checkAdminPin()" style="flex:1">Ø¯Ø®ÙˆÙ„</button><button class="neu-btn btn-red" onclick="closeModal('pinModal')" style="flex:1">Ø¥Ù„ØºØ§Ø¡</button></div></div></div>
    <div id="companySettingsModal" class="modal-overlay"><div class="modal-content"><h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</h3><div class="setting-group"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</label><input type="text" id="confAppName" class="neu-input"></div><div class="setting-group"><label>Ø§Ù„ÙˆØµÙ</label><input type="text" id="confAppDesc" class="neu-input"></div><div class="setting-group"><label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input type="text" id="confAppPhone" class="neu-input"></div><div class="setting-group"><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input type="text" id="confAppAddr" class="neu-input"></div><div class="setting-group" style="border-top:1px solid #ccc;padding-top:15px;"><label style="color:var(--danger)">ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ</label><input type="number" id="confAppPin" class="neu-input" placeholder="Ø¬Ø¯ÙŠØ¯"></div><div style="display:flex;gap:10px;margin-top:20px;"><button class="neu-btn btn-green" onclick="saveCompanyConfig()" style="flex:2">Ø­ÙØ¸</button><button class="neu-btn btn-red" onclick="closeModal('companySettingsModal')" style="flex:1">Ø¥Ù„ØºØ§Ø¡</button></div></div></div>
    <div id="priceSettingsModal" class="modal-overlay"><div class="modal-content"><h3>Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø®Ø¯Ù…Ø§Øª</h3><div id="settingsInputs"></div><div style="display:flex;gap:10px;margin-top:20px;"><button class="neu-btn btn-green" onclick="savePrices()" style="flex:1">Ø­ÙØ¸</button><button class="neu-btn btn-red" onclick="closeModal('priceSettingsModal')" style="flex:1">Ø¥Ù„ØºØ§Ø¡</button></div></div></div>

    <div id="printable-area">
        <div class="invoice-header">
            <div class="company-name" id="p_compName"></div>
            <div class="company-details">
                <div id="p_compDesc"></div>
                <div id="p_compPhone"></div>
                <div id="p_compAddr"></div>
            </div>
        </div>
        <div class="invoice-meta">
            <div><strong>Ø§Ù„Ø²Ø¨ÙˆÙ†:</strong> <span id="p_clientName"></span></div>
            <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> <span id="p_date"></span> | <strong>Ø±Ù‚Ù…:</strong> <span id="p_ref"></span></div>
        </div>
        <table><thead><tr><th>Ø§Ù„Ø¨ÙŠØ§Ù†</th><th>Ø§Ù„Ø¹Ø¯Ø¯</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th></tr></thead><tbody id="p_tableBody"></tbody></table>
        <div id="p_paySection" style="display:none;margin-top:20px;"><h4>Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙØ¹Ø§Øª</h4><table style="width:60%;margin-right:auto;"><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead><tbody id="p_payBody"></tbody></table></div>
        <div class="totals-box"><div style="display:flex;justify-content:space-between;"><span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</span><span id="p_total">0</span></div><div style="display:flex;justify-content:space-between;color:#10b981;"><span>Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</span><span id="p_paid">0</span></div><div style="display:flex;justify-content:space-between;font-weight:bold;border-top:2px solid #ddd;margin-top:10px;padding-top:10px;"><span>Ø§Ù„Ø¨Ø§Ù‚ÙŠ:</span><span id="p_remain">0</span></div></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ğŸ”´ ğŸ”´ ğŸ”´ Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ Ø¨Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ ğŸ”´ ğŸ”´ ğŸ”´
        const firebaseConfig = {
            apiKey: "Ø¶Ø¹_ÙƒÙˆØ¯_API_KEY_Ù‡Ù†Ø§",
            authDomain: "proelec-app.firebaseapp.com",
            projectId: "proelec-app",
            storageBucket: "proelec-app.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:xxxxxx"
        };
        // -------------------------------------------------------------

        // ØªÙ‡ÙŠØ¦Ø© ÙØ§ÙŠØ±Ø¨ÙŠØ³
        let app, dbFirestore;
        try {
            app = initializeApp(firebaseConfig);
            dbFirestore = getFirestore(app);
            console.log("ğŸ”¥ Firebase initialized");
            
            // ØªØ¹ÙŠÙŠÙ† Ù…Ø¤Ø´Ø± Ø§Ù„Ø§ØªØµØ§Ù„
            document.getElementById('cloudStatus').innerHTML = '<i class="fas fa-wifi"></i> Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø©';
            document.getElementById('cloudStatus').className = 'cloud-status status-online';

            // Ø¬Ø¹Ù„ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù…ØªØ§Ø­Ø© Ù„Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
            window.dbFirestore = dbFirestore;
            window.doc = doc;
            window.getDoc = getDoc;
            window.setDoc = setDoc;

            // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
            window.loadFromCloud();
        } catch(e) {
            console.error("Firebase Error", e);
            document.getElementById('cloudStatus').innerHTML = '<i class="fas fa-exclamation-triangle"></i> ÙˆØ¶Ø¹ ØºÙŠØ± Ù…ØªØµÙ„ (Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ© ÙÙ‚Ø·)';
            document.getElementById('cloudStatus').className = 'cloud-status status-offline';
        }
    </script>
    <script>
        // Main Application Logic (V35)
        let db = [], config = { name: "ProElec", pin: "0000" }, savedPrices, state;
        let defaultPrices = { socket: { name: 'ØªØ±ÙƒÙŠØ¨ Ù…Ø£Ø®Ø°', price: 700, icon: 'fa-plug' }, light: { name: 'Ù†Ù‚Ø·Ø© Ø¥Ù†Ø§Ø±Ø©', price: 800, icon: 'fa-lightbulb' }, cable: { name: 'Ø³Ø­Ø¨ ÙƒØ§Ø¨Ù„Ø§Øª', price: 150, icon: 'fa-bezier-curve' }, panel: { name: 'Ø·Ø¨Ù„ÙˆÙ†', price: 5000, icon: 'fa-server' }, drill: { name: 'Ø­ÙØ± Ø§Ù„Ø¹Ù„Ø¨', price: 150, icon: 'fa-hammer' }, breaker: { name: 'ØªØ±ÙƒÙŠØ¨ Ù‚Ø§Ø·Ø¹Ø©', price: 350, icon: 'fa-toggle-on' } };

        window.onload = () => {
            loadLocalData();
            document.getElementById('payDate').valueAsDate = new Date();
            renderQuickButtons();
        };

        function loadLocalData() {
            try {
                db = JSON.parse(localStorage.getItem('proElecDB_v28')) || [];
                config = JSON.parse(localStorage.getItem('proElecConfig_v28')) || { name: "ProElec", desc: "Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙˆØªØ±Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ", phone: "", addr: "", pin: "0000" };
                savedPrices = JSON.parse(localStorage.getItem('proElecPrices_v28'));
                if(savedPrices) for(let k in defaultPrices) if(savedPrices[k]) defaultPrices[k].price = savedPrices[k];
                
                state = JSON.parse(localStorage.getItem('proElecState_v31')) || { id: null, name: '', type: 'ÙØ§ØªÙˆØ±Ø© Ù†Ù‡Ø§Ø¦ÙŠØ©', items: [], payments: [] };
                
                applyConfigToUI();
                updateDropdown();
                if(state.id) render();
            } catch(e) { console.error("Local Load Error", e); }
        }

        // --- Cloud Functions ---
        window.loadFromCloud = async function() {
            if(!window.dbFirestore) return;
            try {
                const docRef = window.doc(window.dbFirestore, "app_data", "backup");
                const docSnap = await window.getDoc(docRef);
                
                if (docSnap.exists()) {
                    const cloudData = docSnap.data();
                    console.log("â˜ï¸ Data loaded");
                    db = cloudData.db || [];
                    config = cloudData.config || config;
                    saveToLocalStorage();
                    applyConfigToUI();
                    updateDropdown();
                    if(state.id) {
                        let freshClient = db.find(c => c.id == state.id);
                        if(freshClient) { state = JSON.parse(JSON.stringify(freshClient)); render(); }
                    }
                    alert("ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ…");
                }
            } catch(e) { console.error("Cloud Load Error", e); }
        };

        window.manualSave = async function() {
            if(!window.dbFirestore) return alert("Ø®Ø·Ø£: ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
            const btn = document.querySelector('.fab-main');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...';
            try {
                const dataToSave = { db: db, config: config, timestamp: new Date().toISOString() };
                await window.setDoc(window.doc(window.dbFirestore, "app_data", "backup"), dataToSave);
                alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ø¨Ø£Ù…Ø§Ù† â˜ï¸âœ…");
            } catch(e) { alert("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: " + e.message); } finally { btn.innerHTML = originalText; }
        };

        // --- Core Functions ---
        function applyConfigToUI() { document.getElementById('displayAppName').innerText = config.name; document.getElementById('displayAppDesc').innerText = config.desc; document.title = config.name; }
        
        function render() {
            localStorage.setItem('proElecState_v31', JSON.stringify(state));
            document.getElementById('docType').value = state.type; 
            document.getElementById('clientDropdown').value = state.id || "";
            
            const list = document.getElementById('list'); let h=''; let t=0;
            state.items.forEach((i,x) => { t+=i.price*i.qty; h+=`<li class="item-row"><div><strong>${i.name}</strong> <span style="font-size:0.85em;color:#666;display:block">(${i.qty} x ${i.price.toLocaleString()} Ø¯.Ø¬)</span></div><div style="display:flex;gap:10px;"><button class="action-btn" onclick="editItem(${x})"><i class="fas fa-pen btn-edit-icon"></i></button><button class="action-btn" onclick="delItem(${x})"><i class="fas fa-times btn-del-icon"></i></button></div></li>`; });
            list.innerHTML = h;
            
            const pList = document.getElementById('payList'); let ph=''; let p=0;
            state.payments.forEach((py,x) => { p+=py.amount; ph+=`<div style="display:flex;justify-content:space-between;background:rgba(16,185,129,0.1);padding:10px;border-radius:10px;margin-bottom:8px;align-items:center;"><div><span style="font-weight:bold;color:var(--success)">${py.amount.toLocaleString()}</span> <small style="color:#555">(${py.date})</small></div><div style="display:flex;gap:10px;"><button class="action-btn" onclick="editPayment(${x})"><i class="fas fa-pen btn-edit-icon"></i></button><button class="action-btn" onclick="delPay(${x})"><i class="fas fa-times btn-del-icon"></i></button></div></div>`; });
            pList.innerHTML = ph;
            
            document.getElementById('totalTxt').innerText = t.toLocaleString() + ' Ø¯.Ø¬'; 
            document.getElementById('paidTxt').innerText = p.toLocaleString() + ' Ø¯.Ø¬'; 
            document.getElementById('remainTxt').innerText = (t-p).toLocaleString() + ' Ø¯.Ø¬';
        }

        function saveToLocalStorage() {
            localStorage.setItem('proElecDB_v28', JSON.stringify(db));
            localStorage.setItem('proElecConfig_v28', JSON.stringify(config));
        }

        function saveData() { 
            if(!state.id) return alert('Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„'); 
            state.type=document.getElementById('docType').value; 
            let i=db.findIndex(c=>c.id==state.id); 
            if(i!==-1) db[i]=state; 
            saveToLocalStorage(); 
            if(window.dbFirestore) window.manualSave(); 
        }

        // --- New Modal System Logic ---
        function openClientModal(isEdit) {
            document.getElementById('isEditMode').value = isEdit ? 'true' : 'false';
            document.getElementById('clientModal').style.display = 'flex';
            
            if(isEdit) {
                if(!state.id) { alert("Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹"); closeModal('clientModal'); return; }
                document.getElementById('clientModalTitle').innerText = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„';
                document.getElementById('modalClientName').value = state.name;
            } else {
                document.getElementById('clientModalTitle').innerText = 'Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯';
                document.getElementById('modalClientName').value = '';
            }
            document.getElementById('modalClientName').focus();
        }

        function confirmSaveClient() {
            const name = document.getElementById('modalClientName').value.trim();
            const isEdit = document.getElementById('isEditMode').value === 'true';
            
            if(!name) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…");

            // ğŸ”¥ Check for Duplicates
            // If editing, check if name exists in OTHER clients (not self)
            // If new, check if name exists in ALL clients
            const exists = db.some(c => c.name.trim() === name && (!isEdit || c.id !== state.id));
            if (exists) {
                alert("âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù‡Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹!");
                return;
            }

            if(isEdit) {
                // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…
                state.name = name;
                let idx = db.findIndex(c => c.id == state.id);
                if(idx !== -1) db[idx].name = name;
                saveData(); // Ø­ÙØ¸ Ø³Ø­Ø§Ø¨ÙŠ
                updateDropdown();
                alert("ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… Ø¨Ù†Ø¬Ø§Ø­");
            } else {
                // Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯
                let nc={id:Date.now(), name:name, type:'ÙØ§ØªÙˆØ±Ø© Ù†Ù‡Ø§Ø¦ÙŠØ©', items:[], payments:[]};
                db.push(nc);
                saveToLocalStorage();
                updateDropdown();
                document.getElementById('clientDropdown').value = nc.id;
                loadClient(nc.id);
                saveData(); // Ø­ÙØ¸ Ø³Ø­Ø§Ø¨ÙŠ
            }
            closeModal('clientModal');
        }

        function openDeleteModal() {
            if(!state.id) return alert("Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹");
            document.getElementById('deleteModal').style.display = 'flex';
        }

        function confirmDeleteClient() {
            db = db.filter(c => c.id !== state.id);
            saveToLocalStorage();
            updateDropdown();
            state = {id:null, name:'', type:'ÙØ§ØªÙˆØ±Ø© Ù†Ù‡Ø§Ø¦ÙŠØ©', items:[], payments:[]};
            render();
            if(window.dbFirestore) window.manualSave();
            closeModal('deleteModal');
        }

        // Standard Edit Functions (Items/Payments)
        function editItem(i) { let np=prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¹Ø±', state.items[i].price); if(np!==null){ let nq=prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©', state.items[i].qty); if(nq!==null){ state.items[i].price=parseFloat(np); state.items[i].qty=parseFloat(nq); render(); }}}
        function editPayment(i) { let na=prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¨Ù„Øº:", state.payments[i].amount); if(na!==null){ let nd=prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®:", state.payments[i].date); if(nd!==null){ state.payments[i].amount=parseFloat(na); state.payments[i].date=nd; render(); }}}
        
        function openAdminPanel() { document.getElementById('adminPinInput').value=''; document.getElementById('pinModal').style.display='flex'; document.getElementById('adminPinInput').focus(); }
        function checkAdminPin() { if(document.getElementById('adminPinInput').value===config.pin){ closeModal('pinModal'); openSettings(); } else alert('Ø±Ù…Ø² Ø®Ø§Ø·Ø¦'); }
        function openSettings() { document.getElementById('companySettingsModal').style.display='flex'; document.getElementById('confAppName').value=config.name; document.getElementById('confAppDesc').value=config.desc; document.getElementById('confAppPhone').value=config.phone; document.getElementById('confAppAddr').value=config.addr; }
        function saveCompanyConfig() { config.name=document.getElementById('confAppName').value||"ProElec"; config.desc=document.getElementById('confAppDesc').value; config.phone=document.getElementById('confAppPhone').value; config.addr=document.getElementById('confAppAddr').value; let np=document.getElementById('confAppPin').value; if(np&&np.length>=4) config.pin=np; saveToLocalStorage(); applyConfigToUI(); closeModal('companySettingsModal'); }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        
        function renderQuickButtons() { let g=document.getElementById('quickButtonsGrid'); g.innerHTML=''; for(let k in defaultPrices){ g.innerHTML+=`<button class="neu-btn" onclick="addQuickItem('${k}')"><i class="fas ${defaultPrices[k].icon}"></i><span>${defaultPrices[k].name}</span><span class="price-tag">${defaultPrices[k].price} Ø¯.Ø¬</span></button>`; } }
        function addQuickItem(k) { addItem(defaultPrices[k].name, defaultPrices[k].price); }
        function openPriceSettings() { let c=document.getElementById('settingsInputs'); c.innerHTML=''; for(let k in defaultPrices){ c.innerHTML+=`<div class="setting-row"><label>${defaultPrices[k].name}</label><input type="number" id="p_${k}" value="${defaultPrices[k].price}" class="neu-input"></div>`; } document.getElementById('priceSettingsModal').style.display='flex'; }
        function savePrices() { let n={}; for(let k in defaultPrices){ let v=parseFloat(document.getElementById(`p_${k}`).value); if(v){ defaultPrices[k].price=v; n[k]=v; } } localStorage.setItem('proElecPrices_v28', JSON.stringify(n)); renderQuickButtons(); closeModal('priceSettingsModal'); }
        
        function fillManualInput(s) { let v=s.value; if(!v) return; let [p, n]=v.split('|'); document.getElementById('manualName').value=n; document.getElementById('manualPrice').value=p; }
        function addManualItem() { let n=document.getElementById('manualName').value; let p=parseFloat(document.getElementById('manualPrice').value); if(n&&p){ addItem(n,p); document.getElementById('manualName').value=''; document.getElementById('manualPrice').value=''; } }
        
        function loadClient(id) { if(!id){ state={id:null,name:'',type:'ÙØ§ØªÙˆØ±Ø© Ù†Ù‡Ø§Ø¦ÙŠØ©',items:[],payments:[]}; render(); return; } let f=db.find(c=>c.id==id); if(f){ state=JSON.parse(JSON.stringify(f)); render(); } }
        
        function addItem(n,p) { let ex=state.items.find(x=>x.name===n); if(ex) ex.qty++; else state.items.push({name:n,price:p,qty:1}); render(); }
        function addPayment() { let a=parseFloat(document.getElementById('payAmount').value); let d=document.getElementById('payDate').value; if(a){ state.payments.push({amount:a,date:d}); document.getElementById('payAmount').value=''; render(); } }
        function delItem(i){ state.items.splice(i,1); render(); } function delPay(i){ state.payments.splice(i,1); render(); }
        function updateDropdown() { let s=document.getElementById('clientDropdown'); let h='<option value="">-- Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„Ø§Ù‹ --</option>'; db.forEach(c=>h+=`<option value="${c.id}">${c.name}</option>`); s.innerHTML=h; }
        function shareWhatsapp() { if (!state.name) return alert('Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„Ø§Ù‹'); let t = `*ÙØ§ØªÙˆØ±Ø©: ${state.name}*\nÙ…Ø¬Ù…ÙˆØ¹: ${document.getElementById('totalTxt').innerText}\nØ¨Ø§Ù‚ÙŠ: ${document.getElementById('remainTxt').innerText}`; if(config.phone) t+=`\nØªÙˆØ§ØµÙ„: ${config.phone}`; window.open(`https://wa.me/?text=${encodeURIComponent(t)}`, '_blank'); }

        function forcePrint() {
            if(!state.name) return alert('Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„Ø§Ù‹');
            document.getElementById('p_compName').innerText = config.name || "ProElec";
            document.getElementById('p_compDesc').innerText = config.desc || "";
            document.getElementById('p_compPhone').innerText = config.phone ? "Ø§Ù„Ù‡Ø§ØªÙ: "+config.phone : "";
            document.getElementById('p_compAddr').innerText = config.addr ? "Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: "+config.addr : "";
            document.getElementById('p_clientName').innerText = state.name;
            document.getElementById('p_date').innerText = new Date().toLocaleDateString('ar-DZ');
            document.getElementById('p_ref').innerText = "#" + String(state.id).slice(-5);
            let h=''; let t=0; state.items.forEach(i=>{ let s=i.price*i.qty; t+=s; h+=`<tr><td>${i.name}</td><td>${i.qty}</td><td>${i.price}</td><td>${s.toLocaleString()}</td></tr>`; }); document.getElementById('p_tableBody').innerHTML=h;
            let ph=''; let p=0; if(state.payments.length){ document.getElementById('p_paySection').style.display='block'; state.payments.forEach(py=>{ p+=py.amount; ph+=`<tr><td>${py.date}</td><td>${py.amount.toLocaleString()}</td></tr>`; }); document.getElementById('p_payBody').innerHTML=ph; } else document.getElementById('p_paySection').style.display='none';
            document.getElementById('p_total').innerText = t.toLocaleString(); document.getElementById('p_paid').innerText = p.toLocaleString(); document.getElementById('p_remain').innerText = (t-p).toLocaleString();
            window.print();
        }
    </script>
</body>
</html>
