<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="apple-touch-icon" href="./finalicon.png">
<link rel="icon" type="image/png" href="./finalicon.png">
    <title>تطبيق محاسبة الكهرباء | ProElec V10</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-color: #e0e5ec;
            --text-main: #4a4a4a;
            --text-light: #888;
            --primary: #4d79ff;
            --success: #219653;
            --danger: #eb5757;
            
            --shadow-light: -9px -9px 16px rgba(255,255,255, 0.8);
            --shadow-dark: 9px 9px 16px rgba(163,177,198, 0.6);
            --inner-shadow: inset 6px 6px 10px 0 rgba(163,177,198, 0.7), inset -6px -6px 10px 0 rgba(255,255,255, 0.8);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }

        body {
            background-color: var(--bg-color);
            font-family: 'Cairo', sans-serif;
            color: var(--text-main);
            min-height: 100vh;
            padding-bottom: 50px;
        }

        /* --- Neumorphism Utilities --- */
        .neu-card {
            background-color: var(--bg-color);
            box-shadow: var(--shadow-dark), var(--shadow-light);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(255,255,255,0.2);
            position: relative;
        }

        .neu-input {
            width: 100%;
            border: none;
            background: var(--bg-color);
            box-shadow: var(--inner-shadow);
            border-radius: 12px;
            padding: 12px 15px;
            font-family: 'Cairo', sans-serif;
            font-size: 14px;
            color: var(--text-main);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* --- SUPER ZOOM INPUT --- */
        .input-zoom {
            position: relative;
            z-index: 1;
            transition: all 0.2s ease;
        }
        
        .input-zoom:focus {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            width: calc(100% - 20px);
            height: 85px;
            font-size: 40px;
            font-weight: 800;
            color: var(--primary);
            background-color: #fff;
            box-shadow: 0 20px 50px rgba(0,0,0, 0.3);
            padding: 0 20px;
            text-align: center;
            border: 3px solid var(--primary);
            border-radius: 15px;
            z-index: 999;
        }
        
        .input-zoom:focus::placeholder { color: transparent; }

        .neu-btn {
            border: none;
            background: var(--bg-color);
            box-shadow: var(--shadow-dark), var(--shadow-light);
            border-radius: 12px;
            padding: 10px 20px;
            color: var(--primary);
            font-weight: 700;
            font-family: 'Cairo', sans-serif;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .neu-btn:active { box-shadow: var(--inner-shadow); transform: translateY(2px); }
        .neu-btn.primary { color: var(--primary); }
        .neu-btn.danger { color: var(--danger); }
        .neu-btn.success { color: var(--success); }
        .neu-btn.warning { color: #f2994a; }
        
        .neu-btn.small { padding: 5px 12px; font-size: 12px; border-radius: 8px; }

        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        header { text-align: center; margin-bottom: 30px; padding-top: 20px; }
        h1 { font-size: 24px; color: var(--primary); margin-bottom: 5px; }
        h2 { font-size: 18px; margin-bottom: 15px; border-right: 4px solid var(--primary); padding-right: 10px; }
        p.subtitle { color: var(--text-light); font-size: 14px; }

        .tabs { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; }
        .tab-btn { flex: 1; max-width: 150px; }
        .tab-btn.active { box-shadow: var(--inner-shadow); color: var(--primary); }

        .form-row { display: flex; gap: 15px; margin-bottom: 15px; align-items: flex-end; }
        .form-group { flex: 1; }
        label { display: block; margin-bottom: 8px; font-size: 13px; font-weight: 600; color: var(--text-light); }

        .quick-add-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .quick-btn { flex-direction: column; padding: 15px; text-align: center; font-size: 12px; height: 80px; color: var(--text-main); }
        .quick-btn i { font-size: 20px; margin-bottom: 5px; color: var(--primary); }

        /* --- Table Styling (Unified for Invoice & Payments) --- */
        .invoice-table-wrapper { 
            overflow-x: auto; 
            border-radius: 12px; 
            margin-bottom: 10px;
            /* Enhance scroll experience */
            -webkit-overflow-scrolling: touch; 
        }
        
        table { width: 100%; border-collapse: collapse; min-width: 500px; /* Force scroll on mobile */ }
        th { text-align: right; padding: 12px; font-size: 13px; color: var(--text-light); border-bottom: 1px solid rgba(0,0,0,0.05); }
        td { padding: 12px; font-size: 14px; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .col-qty { text-align: center; font-weight: bold; color: var(--primary); width: 60px; }
        .col-action { width: 90px; text-align: center; white-space: nowrap; }

        .payments-detail-box { 
            margin-top: 20px; 
            padding: 15px; 
            border: 1px solid rgba(0,0,0,0.05); 
            border-radius: 12px; 
            background: rgba(255,255,255,0.3); 
        }
        
        .payments-table th { font-size: 12px; background: rgba(0,0,0,0.02); }
        .payments-table td { font-size: 13px; padding: 8px 12px; }

        .summary-box { margin-top: 20px; padding-top: 15px; border-top: 2px dashed rgba(0,0,0,0.1); }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; }
        .total-row { font-size: 18px; font-weight: 700; color: var(--primary); margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.1); }
        .paid-text { color: var(--success); }
        .debt-text { color: var(--danger); }

        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .history-item:last-child { border-bottom: none; }
        .history-date { font-size: 12px; color: var(--text-light); }

        .hidden { display: none; }
        .text-center { text-align: center; }
        .mt-20 { margin-top: 20px; }

        @media print {
            body { background: white; padding: 0; }
            .neu-card { box-shadow: none; border: 1px solid #ddd; margin-bottom: 10px; border-radius: 0; }
            .neu-input { box-shadow: none; border: 1px solid #eee; padding: 5px; }
            .no-print, .tabs, .quick-add-grid, .col-action, .neu-btn, .settings-area { display: none !important; }
            .container { max-width: 100%; width: 100%; }
            header { margin-bottom: 10px; }
            table { width: 100%; border: 1px solid #eee; }
            th, td { border: 1px solid #eee; }
            .payments-detail-box { border: 1px solid #000; background: none; }
            .col-qty { font-weight: 900; background-color: #f9f9f9; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1><i class="fa-solid fa-bolt"></i> ProElec</h1>
        <p class="subtitle">نظام فوترة الخدمات الكهربائية</p>
    </header>

    <div class="tabs no-print">
        <button class="neu-btn tab-btn active" onclick="switchTab('dashboard')">
            <i class="fa-solid fa-file-invoice"></i> الفوترة
        </button>
        <button class="neu-btn tab-btn" onclick="switchTab('history')">
            <i class="fa-solid fa-users-viewfinder"></i> الزبائن والسجل
        </button>
        <button class="neu-btn tab-btn" onclick="switchTab('settings')">
            <i class="fa-solid fa-gear"></i> البيانات
        </button>
    </div>

    <div id="dashboard-view">
        
        <div class="neu-card">
            <h2><i class="fa-solid fa-user-tag"></i> بيانات المشروع والزبون</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>اسم الزبون</label>
                    <div style="display:flex; gap:10px;">
                        <select id="customerSelect" class="neu-input" onchange="handleCustomerChange()">
                            <option value="">-- اختر زبوناً --</option>
                        </select>
                        <button class="neu-btn small" onclick="addNewCustomer()" title="زبون جديد"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>
                <div class="form-group">
                    <label>نوع الوثيقة</label>
                    <select id="docType" class="neu-input">
                        <option value="فاتورة">فاتورة نهائية</option>
                        <option value="عرض سعر">عرض سعر (Devis)</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>عنوان المشروع</label>
                    <input type="text" id="projectAddress" class="neu-input" placeholder="مثال: حي الصنوبر، فيلا 12...">
                </div>
                <div class="form-group">
                    <label>رقم الوثيقة (الخاص بالزبون)</label>
                    <input type="text" id="docNumber" class="neu-input" onchange="saveDocNumber()" placeholder="رقم تسلسلي">
                </div>
            </div>
        </div>

        <div class="neu-card no-print">
            <h2><i class="fa-solid fa-bolt-lightning"></i> إضافة سريعة (الخدمات)</h2>
            <div class="quick-add-grid">
                <button class="neu-btn quick-btn" onclick="addQuickItem('تركيب مأخذ (Prise)', 700)">
                    <i class="fa-solid fa-plug"></i> تركيب مأخذ
                </button>
                <button class="neu-btn quick-btn" onclick="addQuickItem('تركيب إنارة (Spot)', 500)">
                    <i class="fa-regular fa-lightbulb"></i> نقطة إنارة
                </button>
                <button class="neu-btn quick-btn" onclick="addQuickItem('تركيب طبلون', 5000)">
                    <i class="fa-solid fa-server"></i> طبلون
                </button>
                <button class="neu-btn quick-btn" onclick="addQuickItem('سحب كابلات', 2000)">
                    <i class="fa-solid fa-code-branch"></i> سحب كابلات
                </button>
                <button class="neu-btn quick-btn" onclick="addQuickItem('حفر العلب', 150)">
                    <i class="fa-solid fa-hammer"></i> حفر العلب
                </button>
                <button class="neu-btn quick-btn" onclick="addQuickItem('تركيب قاطعة', 350)">
                    <i class="fa-solid fa-toggle-on"></i> تركيب قاطعة
                </button>
            </div>

            <div style="border-top: 1px dashed #ccc; padding-top:15px; margin-top:10px;">
                <label>إضافة يدوية:</label>
                <div class="form-row" style="align-items: flex-end;">
                    <input type="text" id="manualName" class="neu-input" placeholder="اسم الخدمة" style="flex:2">
                    <input type="number" id="manualPrice" class="neu-input" placeholder="السعر" style="flex:1">
                    <input type="number" id="manualQty" class="neu-input" value="1" style="flex:0.5">
                    <button class="neu-btn primary" onclick="addManualItem()"><i class="fa-solid fa-plus"></i></button>
                </div>
            </div>
        </div>

        <div class="neu-card no-print">
            <h2><i class="fa-solid fa-money-bill-wave"></i> تسجيل دفعة مالية</h2>
            <div class="form-row">
                <div class="form-group" style="flex: 2;">
                    <label>المبلغ المدفوع (DZD)</label>
                    <input type="number" id="payAmount" class="neu-input input-zoom" placeholder="أدخل المبلغ..." onkeypress="checkEnterPayment(event)">
                </div>
                <div class="form-group">
                    <label>تاريخ الدفع</label>
                    <input type="date" id="payDate" class="neu-input">
                </div>
                <button class="neu-btn success" style="height: 48px;" onclick="recordPayment()">تسجيل <i class="fa-solid fa-check"></i></button>
            </div>
        </div>

        <div class="neu-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2><i class="fa-solid fa-list-check"></i> تفاصيل الفاتورة</h2>
                <div class="no-print">
                    <button class="neu-btn danger small" onclick="clearInvoice()">مسح الكل</button>
                </div>
            </div>
            
            <div class="invoice-table-wrapper">
                <table id="invoiceTable">
                    <thead>
                        <tr>
                            <th style="width: 40%">البند / الخدمة</th>
                            <th class="col-qty">العدد</th>
                            <th>السعر</th>
                            <th>المجموع</th>
                            <th class="col-action no-print">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="invoiceBody"></tbody>
                </table>
            </div>

            <div id="paymentsDetailContainer" class="payments-detail-box hidden">
                <h4 style="margin-bottom:10px; font-size:14px; color:var(--text-light); border-bottom:1px solid #ddd; padding-bottom:5px;">
                    <i class="fa-solid fa-receipt"></i> تفاصيل الدفعات المستلمة
                </h4>
                <div class="invoice-table-wrapper">
                    <table class="payments-table">
                        <thead>
                            <tr>
                                <th>تاريخ الدفع</th>
                                <th>المبلغ</th>
                                <th class="no-print" style="width:70px;">تعديل</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsDetailBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="summary-box">
                <div class="form-row no-print" style="max-width: 200px;">
                    <div class="form-group">
                        <label>نسبة الضريبة (%)</label>
                        <input type="number" id="taxRate" class="neu-input" value="0" onchange="calculateTotals()">
                    </div>
                </div>

                <div class="summary-row">
                    <span>المجموع الفرعي:</span>
                    <span id="subTotalDisplay">0.00 د.ج</span>
                </div>
                <div class="summary-row total-row">
                    <span>المجموع الإجمالي:</span>
                    <span id="grandTotalDisplay">0.00 د.ج</span>
                </div>
                <div class="summary-row paid-text">
                    <span>مجموع المدفوعات:</span>
                    <span id="totalPaidDisplay">0.00 د.ج</span>
                </div>
                <div class="summary-row debt-text" style="font-weight:bold; font-size:16px;">
                    <span>الباقي للدفع:</span>
                    <span id="remainingDisplay">0.00 د.ج</span>
                </div>
            </div>

            <div class="mt-20 text-center no-print">
                <button class="neu-btn primary" onclick="window.print()">
                    <i class="fa-solid fa-print"></i> طباعة الفاتورة
                </button>
            </div>
        </div>
    </div>

    <div id="history-view" class="hidden">
        <div class="neu-card">
            <h2><i class="fa-solid fa-clock-rotate-left"></i> سجل العمليات للزبون</h2>
            <div id="historyList">
                <p style="text-align:center; padding:20px; color:#888;">الرجاء اختيار زبون من القائمة لعرض السجل.</p>
            </div>
        </div>
    </div>

    <div id="settings-view" class="hidden settings-area">
        <div class="neu-card">
            <h2><i class="fa-solid fa-database"></i> إدارة البيانات</h2>
            <div style="display:flex; gap:15px; flex-wrap:wrap;">
                <button class="neu-btn primary" onclick="backupData()">
                    <i class="fa-solid fa-download"></i> تصدير (JSON)
                </button>
                <div style="position:relative; display:inline-block;">
                    <button class="neu-btn" onclick="document.getElementById('fileInput').click()">
                        <i class="fa-solid fa-upload"></i> استعادة
                    </button>
                    <input type="file" id="fileInput" style="display:none" accept=".json" onchange="restoreData(this)">
                </div>
                <button class="neu-btn danger" onclick="resetApp()">
                    <i class="fa-solid fa-trash"></i> تصفير المصنع
                </button>
            </div>
        </div>
    </div>

</div>

<script>
    let appData = {
        customers: [], 
        transactions: [],
        drafts: {},
        currentInvoiceItems: [],
        currentCustomerId: null,
        taxRate: 0,
        globalSeq: 1, 
        projectAddr: ''
    };

    window.onload = function() {
        loadData();
        renderCustomers();
        document.getElementById('payDate').valueAsDate = new Date();
        if (!appData.drafts) appData.drafts = {};
        if(appData.customers.length > 0 && appData.currentCustomerId) {
            document.getElementById('customerSelect').value = appData.currentCustomerId;
            handleCustomerChange();
        }
    };

    function saveData() {
        appData.taxRate = document.getElementById('taxRate').value;
        appData.projectAddr = document.getElementById('projectAddress').value;
        if (appData.currentCustomerId) {
            appData.drafts[appData.currentCustomerId] = appData.currentInvoiceItems;
        }
        localStorage.setItem('proElecDataV10', JSON.stringify(appData));
    }

    function loadData() {
        const stored = localStorage.getItem('proElecDataV10');
        if (stored) {
            appData = JSON.parse(stored);
            if (!appData.drafts) appData.drafts = {};
            if (!appData.globalSeq) appData.globalSeq = 1;
            
            document.getElementById('taxRate').value = appData.taxRate || 0;
            document.getElementById('projectAddress').value = appData.projectAddr || '';
        }
    }

    function addNewCustomer() {
        const name = prompt("أدخل اسم الزبون الجديد:");
        if (name && name.trim() !== "") {
            let nextSeq = (appData.globalSeq || 1).toString().padStart(3, '0');
            const newCustomer = { 
                id: Date.now().toString(), 
                name: name.trim(),
                docNum: nextSeq
            };
            appData.globalSeq = (appData.globalSeq || 1) + 1;
            appData.customers.push(newCustomer);
            appData.drafts[newCustomer.id] = [];
            saveData();
            renderCustomers();
            document.getElementById('customerSelect').value = newCustomer.id;
            handleCustomerChange();
        }
    }

    function renderCustomers() {
        const select = document.getElementById('customerSelect');
        select.innerHTML = '<option value="">-- اختر زبوناً --</option>';
        appData.customers.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = c.name;
            select.appendChild(opt);
        });
        if(appData.currentCustomerId) select.value = appData.currentCustomerId;
    }

    function handleCustomerChange() {
        const newId = document.getElementById('customerSelect').value;
        appData.currentCustomerId = newId;
        
        if (newId && appData.drafts[newId]) {
            appData.currentInvoiceItems = appData.drafts[newId];
        } else {
            appData.currentInvoiceItems = [];
        }

        const customer = appData.customers.find(c => c.id === newId);
        if(customer) {
            document.getElementById('docNumber').value = customer.docNum || '';
        } else {
            document.getElementById('docNumber').value = '';
        }

        saveData();
        renderInvoice();
        calculateTotals();
        renderHistory();
        renderInvoicePayments();
    }

    function saveDocNumber() {
        if(!appData.currentCustomerId) return;
        const val = document.getElementById('docNumber').value;
        const customer = appData.customers.find(c => c.id === appData.currentCustomerId);
        if(customer) {
            customer.docNum = val;
            saveData();
        }
    }

    function addQuickItem(name, price) {
        if(!checkCustomerSelected()) return;
        addItem(name, price, 1);
    }

    function addManualItem() {
        if(!checkCustomerSelected()) return;
        const name = document.getElementById('manualName').value;
        const price = parseFloat(document.getElementById('manualPrice').value);
        const qty = parseFloat(document.getElementById('manualQty').value);
        if (name && price && qty) {
            addItem(name, price, qty);
            document.getElementById('manualName').value = '';
            document.getElementById('manualPrice').value = '';
            document.getElementById('manualQty').value = 1;
        } else {
            alert('الرجاء تعبئة جميع الحقول');
        }
    }

    function checkCustomerSelected() {
        if(!appData.currentCustomerId) {
            alert("الرجاء اختيار زبون أولاً لحفظ البنود في ملفه!");
            return false;
        }
        return true;
    }

    function addItem(name, price, qty) {
        price = parseFloat(price);
        qty = parseFloat(qty);
        const existingItem = appData.currentInvoiceItems.find(item => 
            item.name === name && parseFloat(item.price) === price
        );
        if (existingItem) {
            existingItem.qty = parseFloat(existingItem.qty) + qty;
        } else {
            appData.currentInvoiceItems.push({
                id: Date.now(),
                name: name,
                price: price,
                qty: qty
            });
        }
        saveData();
        renderInvoice();
    }

    function editItemPrice(id) {
        const item = appData.currentInvoiceItems.find(i => i.id === id);
        if(item) {
            const newPrice = prompt("تعديل السعر لـ " + item.name, item.price);
            if(newPrice && !isNaN(newPrice)) {
                item.price = parseFloat(newPrice);
                saveData();
                renderInvoice();
            }
        }
    }

    function removeItem(id) {
        appData.currentInvoiceItems = appData.currentInvoiceItems.filter(item => item.id !== id);
        saveData();
        renderInvoice();
    }

    function clearInvoice() {
        if(confirm("هل أنت متأكد من مسح جميع البنود لهذا الزبون؟")) {
            appData.currentInvoiceItems = [];
            saveData();
            renderInvoice();
        }
    }

    function renderInvoice() {
        const tbody = document.getElementById('invoiceBody');
        tbody.innerHTML = '';
        
        appData.currentInvoiceItems.forEach(item => {
            const total = item.price * item.qty;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${item.name}</td>
                <td class="col-qty">${item.qty}</td>
                <td style="text-align:center">${formatCurrency(item.price)}</td>
                <td style="font-weight:bold; text-align:center">${formatCurrency(total)}</td>
                <td class="col-action no-print">
                    <button class="neu-btn warning small" onclick="editItemPrice(${item.id})" title="تعديل السعر"><i class="fa-solid fa-pen"></i></button>
                    <button class="neu-btn danger small" onclick="removeItem(${item.id})" title="حذف"><i class="fa-solid fa-times"></i></button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        calculateTotals();
    }

    function checkEnterPayment(event) {
        if (event.key === "Enter") {
            event.preventDefault(); 
            recordPayment();
        }
    }

    function recordPayment() {
        if (!appData.currentCustomerId) { alert("الرجاء اختيار زبون أولاً!"); return; }
        const amount = parseFloat(document.getElementById('payAmount').value);
        const date = document.getElementById('payDate').value;

        if (amount && date) {
            appData.transactions.push({
                id: Date.now(),
                customerId: appData.currentCustomerId,
                amount: amount,
                date: date,
                type: 'payment'
            });
            document.getElementById('payAmount').value = '';
            document.getElementById('payAmount').blur(); 
            saveData();
            calculateTotals();
            renderHistory();
            renderInvoicePayments();
            alert("تم تسجيل الدفعة بنجاح");
        } else {
            alert("الرجاء إدخال المبلغ والتاريخ");
        }
    }

    function editTransaction(id) {
        const t = appData.transactions.find(x => x.id === id);
        if(!t) return;
        
        const newAmount = prompt("تعديل مبلغ الدفعة:", t.amount);
        if(newAmount === null) return; 
        
        if(isNaN(parseFloat(newAmount)) || newAmount.trim() === "") {
            alert("مبلغ غير صالح");
            return;
        }

        const newDate = prompt("تعديل التاريخ (YYYY-MM-DD):", t.date);
        if(newDate === null) return;

        t.amount = parseFloat(newAmount);
        t.date = newDate;
        
        saveData();
        calculateTotals();
        renderHistory();
        renderInvoicePayments();
    }

    function calculateTotals() {
        let subTotal = appData.currentInvoiceItems.reduce((sum, item) => sum + (item.price * item.qty), 0);
        let tax = subTotal * (parseFloat(appData.taxRate || 0) / 100);
        let grandTotal = subTotal + tax;
        let totalPaid = 0;
        if (appData.currentCustomerId) {
            totalPaid = appData.transactions
                .filter(t => t.customerId === appData.currentCustomerId)
                .reduce((sum, t) => sum + t.amount, 0);
        }
        let remaining = grandTotal - totalPaid;

        document.getElementById('subTotalDisplay').textContent = formatCurrency(subTotal);
        document.getElementById('grandTotalDisplay').textContent = formatCurrency(grandTotal);
        document.getElementById('totalPaidDisplay').textContent = formatCurrency(totalPaid);
        document.getElementById('remainingDisplay').textContent = formatCurrency(remaining);
        
        const remEl = document.getElementById('remainingDisplay');
        if (remaining > 0) remEl.style.color = 'var(--danger)';
        else if (remaining < 0) remEl.style.color = 'var(--success)';
        else remEl.style.color = 'var(--text-main)';
    }

    function renderInvoicePayments() {
        const container = document.getElementById('paymentsDetailContainer');
        const tbody = document.getElementById('paymentsDetailBody');
        if (!appData.currentCustomerId) { container.classList.add('hidden'); return; }
        const customerTrans = appData.transactions
            .filter(t => t.customerId === appData.currentCustomerId)
            .sort((a, b) => new Date(a.date) - new Date(b.date));
        if (customerTrans.length === 0) { container.classList.add('hidden'); return; }
        container.classList.remove('hidden');
        tbody.innerHTML = '';
        customerTrans.forEach(t => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${t.date}</td>
                <td style="color:var(--success); font-weight:bold;">${formatCurrency(t.amount)}</td>
                <td class="no-print" style="text-align:center;">
                    <button class="neu-btn warning small" onclick="editTransaction(${t.id})"><i class="fa-solid fa-pen"></i></button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderHistory() {
        const container = document.getElementById('historyList');
        if (!appData.currentCustomerId) {
            container.innerHTML = '<p style="text-align:center; padding:20px;">الرجاء اختيار زبون.</p>';
            return;
        }
        const customerTrans = appData.transactions
            .filter(t => t.customerId === appData.currentCustomerId)
            .sort((a, b) => new Date(b.date) - new Date(a.date));
        container.innerHTML = customerTrans.length ? '' : '<p style="text-align:center;">لا توجد دفعات.</p>';
        customerTrans.forEach(t => {
            const div = document.createElement('div');
            div.className = 'history-item';
            div.innerHTML = `
                <div>
                    <div style="font-weight:bold; color:var(--success)">+ ${formatCurrency(t.amount)}</div>
                    <div class="history-date">${t.date}</div>
                </div>
                <div>
                    <button class="neu-btn warning small" onclick="editTransaction(${t.id})" style="margin-left:5px;"><i class="fa-solid fa-pen"></i></button>
                    <button class="neu-btn danger small" onclick="deleteTransaction(${t.id})"><i class="fa-solid fa-trash"></i></button>
                </div>
            `;
            container.appendChild(div);
        });
    }

    function deleteTransaction(id) {
        if(confirm("حذف الدفعة؟")) {
            appData.transactions = appData.transactions.filter(t => t.id !== id);
            saveData(); calculateTotals(); renderHistory(); renderInvoicePayments();
        }
    }

    function formatCurrency(num) {
        return new Intl.NumberFormat('ar-DZ', { style: 'currency', currency: 'DZD' }).format(num);
    }

    function switchTab(tabName) {
        document.getElementById('dashboard-view').classList.add('hidden');
        document.getElementById('history-view').classList.add('hidden');
        document.getElementById('settings-view').classList.add('hidden');
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(tabName + '-view').classList.remove('hidden');
        if(tabName === 'dashboard') document.querySelectorAll('.tab-btn')[0].classList.add('active');
        if(tabName === 'history') document.querySelectorAll('.tab-btn')[1].classList.add('active');
        if(tabName === 'settings') document.querySelectorAll('.tab-btn')[2].classList.add('active');
    }

    function backupData() {
        saveData();
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
        const a = document.createElement('a');
        a.href = dataStr;
        a.download = "proelec_backup_v10.json";
        a.click();
    }

    function restoreData(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                appData = JSON.parse(e.target.result);
                saveData();
                location.reload();
            } catch (err) { alert("خطأ في الملف"); }
        };
        reader.readAsText(file);
    }

    function resetApp() {
        if(confirm("حذف جميع البيانات؟")) { localStorage.removeItem('proElecDataV10'); location.reload(); }
    }
    if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then(reg => console.log('تم تفعيل وضع الأوفلاين بنجاح!'))
      .catch(err => console.log('فشل تفعيل الأوفلاين', err));
  });
}

</script>

</body>
</html>
