 <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ProElec V28 - Fixed Backup</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg: #e0e5ec; --primary: #3b82f6; --text-main: #1f2937; --danger: #ef4444; --success: #10b981; --warning: #f59e0b; --whatsapp: #25D366;
            --shadow-light: #ffffff; --shadow-dark: #a3b1c6;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); color: var(--text-main); padding-bottom: 100px; }
        .app-container { width: 100%; max-width: 500px; margin: 0 auto; padding: 25px 15px; }

        /* UI Components */
        .neu-box { background: var(--bg); border-radius: 25px; box-shadow: 9px 9px 18px var(--shadow-dark), -9px -9px 18px var(--shadow-light); padding: 25px; margin-bottom: 30px; border: 1px solid rgba(255,255,255,0.4); }
        .neu-input, .neu-select { width: 100%; border: none; background: var(--bg); border-radius: 15px; padding: 16px; margin-bottom: 12px; font-weight: 600; box-shadow: inset 6px 6px 12px var(--shadow-dark), inset -6px -6px 12px var(--shadow-light); outline: none; }
        .neu-btn { background: var(--bg); border: none; border-radius: 18px; box-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light); color: var(--primary); font-weight: 700; padding: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.2s; }
        .neu-btn:active { transform: scale(0.95); box-shadow: inset 6px 6px 12px var(--shadow-dark), inset -6px -6px 12px var(--shadow-light); }
        .btn-green { color: var(--success); } .btn-red { color: var(--danger); }
        .btn-icon-only { width: 45px; height: 45px; border-radius: 50%; padding: 0; }

        .action-btn { width: 35px; height: 35px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; background: var(--bg); box-shadow: 4px 4px 8px var(--shadow-dark), -4px -4px 8px var(--shadow-light); transition: all 0.2s ease; }
        .action-btn:active { box-shadow: inset 2px 2px 5px var(--shadow-dark), inset -2px -2px 5px var(--shadow-light); transform: scale(0.95); }
        .btn-edit-icon { color: var(--warning); font-size: 0.9rem; }
        .btn-del-icon { color: var(--danger); font-size: 0.9rem; }

        /* Brand Header */
        .brand-container { text-align: center; margin-bottom: 25px; position: relative; }
        .brand-title { font-size: 2.2rem; font-weight: 800; background: linear-gradient(45deg, var(--primary), #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: inline-block; }
        .brand-slogan { font-size: 0.9rem; color: #6b7280; margin-top: 5px; }
        .admin-btn { position: absolute; top: 0; left: 0; color: #6b7280; background: none; border: none; font-size: 1.2rem; cursor: pointer; }

        /* Grid & List */
        .services-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .services-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 18px; }
        .services-grid .neu-btn { flex-direction: column; height: 110px; color: #6b7280; position: relative; overflow: hidden; }
        .services-grid .neu-btn i { font-size: 1.8rem; color: var(--primary); margin-bottom: 8px; }
        .price-tag { font-size: 0.75rem; color: var(--primary); margin-top: 5px; opacity: 0.8; }
        
        .manual-add-section { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 20px; }
        .manual-row { display: flex; gap: 10px; }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(255,255,255,0.4); border-radius: 15px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.5); }
        
        /* Floating Dock */
        .fab-bar { position: fixed; bottom: 25px; left: 20px; right: 20px; display: flex; gap: 15px; z-index: 100; background: rgba(224, 229, 236, 0.9); backdrop-filter: blur(10px); padding: 10px 15px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,0.3); }
        .fab-main { flex: 2; background: linear-gradient(135deg, var(--primary), #2563eb); color: white !important; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4); }
        .fab-action { flex: 1; background: #1f2937; color: white !important; }
        .fab-whatsapp { flex: 1; color: var(--whatsapp) !important; font-size: 1.5rem; }

        /* Modals */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .modal-content { background: #e0e5ec; padding: 25px; border-radius: 25px; width: 90%; max-width: 400px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); max-height: 85vh; overflow-y: auto; }
        .setting-group { margin-bottom: 15px; }
        .setting-group label { display: block; margin-bottom: 5px; color: var(--primary); font-weight: bold; font-size: 0.9rem; }
        .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .setting-row input { width: 100px; padding: 10px; text-align: center; }

        /* Print Area */
        #printable-area { display: none; }
        @media print {
            .app-container, .fab-bar, .modal-overlay { display: none !important; }
            body { background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; margin: 0; padding: 0; }
            #printable-area { display: block !important; position: absolute; top: 0; left: 0; width: 100%; padding: 40px; box-sizing: border-box; background: white; }
            
            .invoice-header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid var(--primary); padding-bottom: 20px; }
            .company-name { font-size: 2.5rem; font-weight: 800; color: var(--primary) !important; margin-bottom: 5px; }
            .company-details { font-size: 0.9rem; color: #555; margin-bottom: 20px; }
            .invoice-meta { display: flex; justify-content: space-between; background: #f8f9fa !important; padding: 10px 15px; border-radius: 8px; border: 1px solid #eee; font-size: 0.9rem; margin-bottom: 20px; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 30px; font-size: 11pt; }
            th { background-color: #f3f4f6 !important; color: #111 !important; padding: 12px; border: 1px solid #ddd; }
            td { border: 1px solid #ddd; padding: 10px; color: #333; }
            .totals-box { width: 50%; margin-right: auto; background: #f9fafb !important; border: 1px solid #eee; padding: 20px; border-radius: 10px; page-break-inside: avoid; }
        }
    </style>
</head>
<body>

    <div class="app-container">
        
        <div class="brand-container">
            <button class="admin-btn" onclick="openAdminPanel()" title="إعدادات المؤسسة"><i class="fas fa-lock"></i></button>
            <div class="brand-title" id="displayAppName">ProElec</div>
            <div class="brand-slogan" id="displayAppDesc">نظام الفوترة الاحترافي</div>
        </div>

        <div class="neu-box" style="display:flex; gap:12px; padding:15px;">
            <button class="neu-btn" onclick="exportData()" style="flex:1; font-size:0.85rem;"><i class="fas fa-cloud-download-alt"></i> نسخ احتياطي</button>
            <button class="neu-btn" onclick="document.getElementById('importFile').click()" style="flex:1; font-size:0.85rem;"><i class="fas fa-cloud-upload-alt"></i> استرجاع</button>
            <input type="file" id="importFile" style="display:none" onchange="importData(this)">
        </div>

        <div class="neu-box">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="color:var(--text-main)"><i class="fas fa-user-circle"></i> العميل</h3>
                <button class="neu-btn btn-icon-only" onclick="toggleNewClient()"><i class="fas fa-plus"></i></button>
            </div>
            <div id="dropdownSection">
                <select id="clientDropdown" class="neu-select" onchange="loadClient(this.value)"><option value="">-- اختر عميلاً --</option></select>
            </div>
            <div id="newClientSection" style="display:none; gap:10px;">
                <input type="text" id="newClientName" class="neu-input" placeholder="اسم العميل..." style="margin:0">
                <button class="neu-btn btn-green" style="width:60px" onclick="saveNewClient()"><i class="fas fa-check"></i></button>
            </div>
            <select id="docType" class="neu-input" style="margin-top:10px;"><option>فاتورة نهائية</option><option>عرض سعر (Devis)</option></select>
        </div>

        <div class="neu-box">
            <div class="services-header">
                <h3 style="color:var(--text-main)"><i class="fas fa-bolt" style="color:var(--warning)"></i> إضافة سريعة</h3>
                <button class="neu-btn btn-icon-only" onclick="openPriceSettings()" style="width:35px; height:35px; color:#666;"><i class="fas fa-tags"></i></button>
            </div>
            <div class="services-grid" id="quickButtonsGrid"></div>
            <div class="manual-add-section">
                <label style="font-size:0.9rem; color:#666; margin-bottom:-5px;">خدمات أخرى:</label>
                <select id="extraServicesDropdown" class="neu-select" onchange="fillManualInput(this)">
                    <option value="">-- اختر خدمة للإضافة --</option>
                    <option value="1200|تركيب ثريا (Lustre)">تركيب ثريا (1200 د.ج)</option>
                    <option value="400|تركيب سبوت (Spot)">تركيب سبوت (400 د.ج)</option>
                    <option value="1500|مأخذ مكيف (Climatiseur)">مأخذ مكيف (1500 د.ج)</option>
                    <option value="2500|تأريض (Mise à la terre)">تأريض (2500 د.ج)</option>
                    <option value="800|جرس باب (Sonnette)">جرس باب (800 د.ج)</option>
                    <option value="3000|انترفون (Interphone)">انترفون (3000 د.ج)</option>
                    <option value="2500|كاشف حركة (Détecteur)">كاشف حركة (2500 د.ج)</option>
                    <option value="1500|مروحة سقف">مروحة سقف (1500 د.ج)</option>
                </select>
                <div class="manual-row">
                    <input type="text" id="manualName" class="neu-input" placeholder="اسم الخدمة" style="flex:2; margin:0">
                    <input type="number" id="manualPrice" class="neu-input" placeholder="السعر" style="flex:1; margin:0">
                    <button class="neu-btn btn-green" onclick="addManualItem()" style="width:50px;"><i class="fas fa-plus"></i></button>
                </div>
            </div>
        </div>

        <div class="neu-box">
            <h3 style="margin-bottom:15px; color:var(--text-main)"><i class="fas fa-file-invoice-dollar"></i> الفاتورة</h3>
            <ul id="list" style="list-style:none; min-height:50px;"></ul>
            <div style="margin-top:25px; padding:15px; border:2px dashed rgba(163, 177, 198, 0.5); border-radius:15px;">
                <h4 style="margin-bottom:10px; color:#6b7280; font-size:0.9rem;">تسجيل دفعة</h4>
                <div style="display:flex; gap:10px;">
                    <input type="number" id="payAmount" class="neu-input" placeholder="المبلغ" style="flex:1; margin:0">
                    <input type="date" id="payDate" class="neu-input" style="flex:1; margin:0">
                </div>
                <button class="neu-btn btn-green" onclick="addPayment()" style="width:100%; margin-top:10px; border-radius:12px;"><i class="fas fa-plus-circle"></i> إضافة الدفعة</button>
                <div id="payList" style="margin-top:15px;"></div>
            </div>
            <div style="margin-top:20px; padding-top:15px; border-top:1px solid rgba(0,0,0,0.05);">
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;"><span>المجموع:</span><span id="totalTxt" style="font-weight:700; color:var(--primary)">0</span></div>
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;"><span>المدفوع:</span><span id="paidTxt" style="font-weight:700; color:var(--success)">0</span></div>
                <div style="display:flex; justify-content:space-between; font-size:1.3rem; font-weight:800; color:var(--danger); margin-top:15px;"><span>الباقي:</span><span id="remainTxt">0</span></div>
            </div>
        </div>

        <div class="fab-bar">
            <button class="neu-btn fab-main" onclick="saveData()"><i class="fas fa-save"></i> حفظ</button>
            <button class="neu-btn fab-action btn-red" onclick="deleteClient()"><i class="fas fa-trash-alt"></i></button>
            <button class="neu-btn fab-whatsapp" onclick="shareWhatsapp()"><i class="fab fa-whatsapp"></i></button>
            <button class="neu-btn fab-action" onclick="forcePrint()"><i class="fas fa-print"></i></button>
        </div>
    </div>

    <div id="pinModal" class="modal-overlay"><div class="modal-content" style="text-align:center;"><h3>لوحة المدير</h3><p>أدخل الرمز السري</p><input type="password" id="adminPinInput" class="neu-input" placeholder="****" style="text-align:center;font-size:1.5rem;letter-spacing:5px;"><div style="display:flex;gap:10px;margin-top:15px;"><button class="neu-btn btn-green" onclick="checkAdminPin()" style="flex:1">دخول</button><button class="neu-btn btn-red" onclick="closeModal('pinModal')" style="flex:1">إلغاء</button></div></div></div>
    <div id="companySettingsModal" class="modal-overlay"><div class="modal-content"><h3>إعدادات المؤسسة</h3><div class="setting-group"><label>اسم المؤسسة</label><input type="text" id="confAppName" class="neu-input"></div><div class="setting-group"><label>الوصف</label><input type="text" id="confAppDesc" class="neu-input"></div><div class="setting-group"><label>رقم الهاتف</label><input type="text" id="confAppPhone" class="neu-input"></div><div class="setting-group"><label>العنوان</label><input type="text" id="confAppAddr" class="neu-input"></div><div class="setting-group" style="border-top:1px solid #ccc;padding-top:15px;"><label style="color:var(--danger)">تغيير الرمز السري</label><input type="number" id="confAppPin" class="neu-input" placeholder="جديد"></div><div style="display:flex;gap:10px;margin-top:20px;"><button class="neu-btn btn-green" onclick="saveCompanyConfig()" style="flex:2">حفظ</button><button class="neu-btn btn-red" onclick="closeModal('companySettingsModal')" style="flex:1">إلغاء</button></div></div></div>
    <div id="priceSettingsModal" class="modal-overlay"><div class="modal-content"><h3>أسعار الخدمات</h3><div id="settingsInputs"></div><div style="display:flex;gap:10px;margin-top:20px;"><button class="neu-btn btn-green" onclick="savePrices()" style="flex:1">حفظ</button><button class="neu-btn btn-red" onclick="closeModal('priceSettingsModal')" style="flex:1">إلغاء</button></div></div></div>

    <div id="printable-area">
        <div class="invoice-header"><div class="company-name" id="p_compName"></div><div class="company-details"><div id="p_compDesc"></div><div id="p_compPhone" style="margin-top:5px;"></div><div id="p_compAddr"></div></div></div>
        <div class="invoice-meta"><div><strong>الزبون:</strong> <span id="p_clientName"></span></div><div><strong>التاريخ:</strong> <span id="p_date"></span> | <strong>رقم:</strong> <span id="p_ref"></span></div></div>
        <table><thead><tr><th>البيان</th><th>العدد</th><th>السعر</th><th>المجموع</th></tr></thead><tbody id="p_tableBody"></tbody></table>
        <div id="p_paySection" style="display:none;margin-top:20px;"><h4>سجل الدفعات</h4><table style="width:60%;margin-right:auto;"><thead><tr><th>التاريخ</th><th>المبلغ</th></tr></thead><tbody id="p_payBody"></tbody></table></div>
        <div class="totals-box"><div style="display:flex;justify-content:space-between;"><span>المجموع:</span><span id="p_total">0</span></div><div style="display:flex;justify-content:space-between;color:#10b981;"><span>المدفوع:</span><span id="p_paid">0</span></div><div style="display:flex;justify-content:space-between;font-weight:bold;border-top:2px solid #ddd;margin-top:10px;padding-top:10px;"><span>الباقي:</span><span id="p_remain">0</span></div></div>
        <div style="margin-top:50px; text-align:center; color:#777; font-size:0.8rem;">شكرًا لتعاملكم معنا</div>
    </div>

    <script>
        // Data Init (V28)
        let db = JSON.parse(localStorage.getItem('proElecDB_v28')) || [];
        let config = JSON.parse(localStorage.getItem('proElecConfig_v28')) || { name: "ProElec", desc: "نظام الفوترة الاحترافي", phone: "", addr: "", pin: "0000" };
        let state = { id: null, name: '', type: 'فاتورة نهائية', items: [], payments: [] };
        let defaultPrices = { socket: { name: 'تركيب مأخذ', price: 700, icon: 'fa-plug' }, light: { name: 'نقطة إنارة', price: 800, icon: 'fa-lightbulb' }, cable: { name: 'سحب كابلات', price: 150, icon: 'fa-bezier-curve' }, panel: { name: 'طبلون', price: 5000, icon: 'fa-server' }, drill: { name: 'حفر العلب', price: 150, icon: 'fa-hammer' }, breaker: { name: 'تركيب قاطعة', price: 350, icon: 'fa-toggle-on' } };
        let savedPrices = JSON.parse(localStorage.getItem('proElecPrices_v28'));
        if(savedPrices) { for(let k in defaultPrices) { if(savedPrices[k]) defaultPrices[k].price = savedPrices[k]; } }

        window.onload = () => { applyConfigToUI(); document.getElementById('payDate').valueAsDate = new Date(); updateDropdown(); renderQuickButtons(); };

        // UI Logic
        function applyConfigToUI() { document.getElementById('displayAppName').innerText = config.name; document.getElementById('displayAppDesc').innerText = config.desc; document.title = config.name; }
        
        function render() {
            document.getElementById('docType').value = state.type; document.getElementById('clientDropdown').value = state.id || "";
            const list = document.getElementById('list'); let h=''; let t=0;
            state.items.forEach((i,x) => { t+=i.price*i.qty; h+=`<li class="item-row"><div><strong>${i.name}</strong> <span style="font-size:0.85em;color:#666;display:block">(${i.qty} x ${i.price.toLocaleString()} د.ج)</span></div><div style="display:flex;gap:10px;"><button class="action-btn" onclick="editItem(${x})"><i class="fas fa-pen btn-edit-icon"></i></button><button class="action-btn" onclick="delItem(${x})"><i class="fas fa-times btn-del-icon"></i></button></div></li>`; });
            list.innerHTML = h;
            const pList = document.getElementById('payList'); let ph=''; let p=0;
            state.payments.forEach((py,x) => { p+=py.amount; ph+=`<div style="display:flex;justify-content:space-between;background:rgba(16,185,129,0.1);padding:10px;border-radius:10px;margin-bottom:8px;align-items:center;"><div><span style="font-weight:bold;color:var(--success)">${py.amount.toLocaleString()}</span> <small style="color:#555">(${py.date})</small></div><div style="display:flex;gap:10px;"><button class="action-btn" onclick="editPayment(${x})"><i class="fas fa-pen btn-edit-icon"></i></button><button class="action-btn" onclick="delPay(${x})"><i class="fas fa-times btn-del-icon"></i></button></div></div>`; });
            pList.innerHTML = ph;
            document.getElementById('totalTxt').innerText = t.toLocaleString() + ' د.ج'; document.getElementById('pai
