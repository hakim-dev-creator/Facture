<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>برنامج حساب الخدمات الكهربائية</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* نفس التنسيقات الرائعة التي استخدمتها سابقاً */
        :root { --primary: #1e3799; --accent: #f39c12; --success: #05c46b; --bg: #f8f9fa; --text: #2f3542; --white: #ffffff; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #e0e6ed 0%, #f8f9fa 100%); margin: 0; padding: 15px; color: var(--text); }
        .header { background: var(--primary); padding: 25px 15px; border-radius: 20px 20px 0 0; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .glow-title { color: var(--white); font-size: 22px; font-weight: 800; margin: 0; }
        .container { max-width: 500px; margin: auto; background: var(--white); border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.08); overflow: hidden; }
        .tabs { display: flex; background: #f1f2f6; padding: 5px; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; font-weight: bold; cursor: pointer; color: #747d8c; border-radius: 10px; transition: 0.3s; }
        .tab-btn.active { background: var(--white); color: var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .content { padding: 20px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 14px; font-weight: 600; margin-bottom: 6px; color: var(--primary); }
        input, select { width: 100%; padding: 14px; border: 1.5px solid #dcdde1; border-radius: 12px; font-size: 15px; background: #fdfdfd; box-sizing: border-box; }
        .item-row { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; margin-bottom: 12px; padding: 12px; background: #f9f9f9; border-radius: 12px; border: 1px solid #eee; }
        .btn { width: 100%; padding: 16px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.3s; }
        .btn-add { background: var(--success); color: white; margin-top: 5px; }
        .btn-pdf { background: var(--primary); color: white; margin-top: 25px; box-shadow: 0 4px 15px rgba(30, 55, 153, 0.3); }
        .glow-box { margin-top: 25px; padding: 20px; background: #f0f7ff; border: 2px dashed var(--primary); border-radius: 15px; text-align: center; }
        .glow-box h2 { margin: 8px 0 0; color: var(--primary); font-size: 28px; }
        #pdf-export { width: 800px; padding: 50px; background: white; position: absolute; left: -9999px; }
        .pdf-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .pdf-table th { background: #1e3799; color: white; padding: 15px; }
        .pdf-table td { padding: 15px; border-bottom: 1px solid #eee; text-align: center; font-size: 18px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header"><h1 class="glow-title">برنامج حساب الخدمات الكهربائية</h1></div>
    <div class="tabs">
        <button class="tab-btn active" id="tab-c" onclick="switchTab('calc')">الحاسبة</button>
        <button class="tab-btn" id="tab-v" onclick="switchTab('serv')">الخدمات</button>
        <button class="tab-btn" id="tab-s" onclick="switchTab('sett')">الإعدادات</button>
    </div>

    <div id="sec-calc" class="content">
        <div class="input-group"><label>اسم الزبون:</label><input type="text" id="cliName" placeholder="أدخل اسم الزبون هنا"></div>
        <div id="items-container">
            <div class="item-row">
                <select class="row-desc" onchange="applyService(this)"></select>
                <input type="number" placeholder="كمية" class="row-qty" oninput="doCalc()">
                <input type="number" placeholder="سعر" class="row-prc" oninput="doCalc()">
            </div>
        </div>
        <button class="btn btn-add" onclick="addNewRow()">+ إضافة بند جديد</button>
        <div class="input-group" style="margin-top:20px"><label>الدفعات المقدمة (د.ج):</label><input type="number" id="paidIn" value="0" oninput="doCalc()"></div>
        <div class="glow-box"><small>الصافي المطلوب دفعه:</small><h2 id="net-total">0.00 د.ج</h2></div>
        <button class="btn btn-pdf" id="pdfBtn" onclick="generatePDF()">تصدير الفاتورة PDF</button>
    </div>

    <div id="sec-serv" class="content" style="display:none">
        <div id="master-services"></div>
        <button class="btn btn-add" onclick="addMasterRow('', '')">+ خدمة جديدة</button>
        <button class="btn btn-pdf" style="margin-top:10px" onclick="saveMaster()">حفظ الخدمات</button>
    </div>

    <div id="sec-sett" class="content" style="display:none">
        <div class="input-group"><label>رقم الهاتف:</label><input type="text" id="myPh" onchange="saveInfo()"></div>
        <div class="input-group"><label>العنوان الشخصي:</label><input type="text" id="myAd" onchange="saveInfo()"></div>
    </div>
</div>

<div id="pdf-export" dir="rtl">
    <div style="text-align: center; border-bottom: 5px solid #1e3799; padding-bottom: 20px; margin-bottom: 30px;">
        <h1 style="font-size: 45px; color: #1e3799; margin: 0;">فاتورة أشغال كهربائية</h1>
        <p style="font-size: 20px;">هاتف: <span id="p-ph"></span> | العنوان: <span id="p-ad"></span></p>
    </div>
    <p style="font-size: 24px;"><strong>السيد:</strong> <span id="p-cli"></span></p>
    <table class="pdf-table">
        <thead><tr><th>بيان الأشغال</th><th>الكمية</th><th>سعر الوحدة</th><th>الإجمالي</th></tr></thead>
        <tbody id="p-table-body"></tbody>
    </table>
    <div style="margin-top: 40px; text-align: left;">
        <p style="font-size: 22px;">إجمالي الأشغال: <span id="p-sub"></span> د.ج</p>
        <p style="font-size: 22px;">المبلغ المدفوع: <span id="p-paid"></span> د.ج</p>
        <h2 id="p-net" style="color: #1e3799; font-size: 32px;"></h2>
    </div>
</div>

<script>
    // تفعيل الـ Service Worker للعمل بدون إنترنت
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').then(reg => console.log('Offline Ready!'));
        });
    }

    let services = JSON.parse(localStorage.getItem('pro_services') || '[]');

    function saveInfo() {
        localStorage.setItem('pro_ph', document.getElementById('myPh').value);
        localStorage.setItem('pro_ad', document.getElementById('myAd').value);
        localStorage.setItem('last_client', document.getElementById('cliName').value);
    }

    function switchTab(t) {
        document.getElementById('sec-calc').style.display = t=='calc'?'block':'none';
        document.getElementById('sec-serv').style.display = t=='serv'?'block':'none';
        document.getElementById('sec-sett').style.display = t=='sett'?'block':'none';
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + t.charAt(0)).classList.add('active');
        if(t=='calc') refreshDropdowns();
    }

    function addMasterRow(n, p) {
        let d = document.createElement('div'); d.style.display="flex"; d.style.gap="5px"; d.style.marginBottom="10px";
        d.innerHTML = `<input type="text" class="m-n" value="${n}" placeholder="الخدمة"> 
                       <input type="number" class="m-p" value="${p}" placeholder="السعر">
                       <button onclick="this.parentElement.remove()" style="background:#ff4757; color:white; border:none; padding:10px; border-radius:8px;">X</button>`;
        document.getElementById('master-services').appendChild(d);
    }

    function saveMaster() {
        let list = [];
        document.querySelectorAll('#master-services > div').forEach(r => {
            let n = r.querySelector('.m-n').value, p = r.querySelector('.m-p').value;
            if(n) list.push({n, p});
        });
        localStorage.setItem('pro_services', JSON.stringify(list));
        services = list;
        alert("تم الحفظ بنجاح!");
        refreshDropdowns();
    }

    function refreshDropdowns() {
        let opts = '<option value="">اختر خدمة...</option>' + services.map(s => `<option value="${s.n}" data-p="${s.p}">${s.n}</option>`).join('');
        document.querySelectorAll('.row-desc').forEach(sel => { sel.innerHTML = opts; });
    }

    function applyService(sel) {
        let p = sel.options[sel.selectedIndex].dataset.p;
        if(p) { sel.parentElement.querySelector('.row-prc').value = p; doCalc(); }
    }

    function addNewRow() {
        let d = document.createElement('div'); d.className = 'item-row';
        d.innerHTML = `<select class="row-desc" onchange="applyService(this)"></select>
                       <input type="number" placeholder="كمية" class="row-qty" oninput="doCalc()">
                       <input type="number" placeholder="سعر" class="row-prc" oninput="doCalc()">`;
        document.getElementById('items-container').appendChild(d);
        refreshDropdowns();
    }

    function doCalc() {
        let sub = 0;
        document.querySelectorAll('.item-row').forEach(r => {
            sub += (r.querySelector('.row-qty').value * r.querySelector('.row-prc').value) || 0;
        });
        let p = document.getElementById('paidIn').value || 0;
        let net = sub - p;
        document.getElementById('net-total').innerText = net.toLocaleString() + " د.ج";
        saveInfo();
        return {sub, p, net};
    }

    window.onload = () => {
        document.getElementById('myPh').value = localStorage.getItem('pro_ph') || '';
        document.getElementById('myAd').value = localStorage.getItem('pro_ad') || '';
        document.getElementById('cliName').value = localStorage.getItem('last_client') || '';
        if(services.length > 0) services.forEach(s => addMasterRow(s.n, s.p));
        refreshDropdowns();
    };

    async function generatePDF() {
        const btn = document.getElementById('pdfBtn'); btn.innerText = "جاري التحضير...";
        document.getElementById('p-ph').innerText = document.getElementById('myPh').value;
        document.getElementById('p-ad').innerText = document.getElementById('myAd').value;
        document.getElementById('p-cli').innerText = document.getElementById('cliName').value;
        
        let body = '';
        document.querySelectorAll('.item-row').forEach(r => {
            let d = r.querySelector('.row-desc').value, q = r.querySelector('.row-qty').value || 0, p = r.querySelector('.row-prc').value || 0;
            if(d) body += `<tr><td>${d}</td><td>${q}</td><td>${p}</td><td>${(q*p).toFixed(2)}</td></tr>`;
        });
        
        let res = doCalc();
        document.getElementById('p-table-body').innerHTML = body;
        document.getElementById('p-sub').innerText = res.sub.toFixed(2);
        document.getElementById('p-paid').innerText = res.p;
        document.getElementById('p-net').innerText = "الصافي: " + res.net.toFixed(2) + " د.ج";

        const canvas = await html2canvas(document.getElementById('pdf-export'), { scale: 2 });
        const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
        pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 210, (canvas.height * 210) / canvas.width);
        pdf.save(`فاتورة_${document.getElementById('cliName').value}.pdf`);
        btn.innerText = "تصدير الفاتورة PDF";
    }
</script>
</body>
</html>
